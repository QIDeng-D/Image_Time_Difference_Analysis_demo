# 时间戳同步分析功能 (Timestamp Synchronization Analysis)

## 概述 (Overview)

本功能通过分析视频的时间戳JSONL文件，提供详细的同步质量评估，不仅看帧数，还分析时间对齐质量。

## 功能特性 (Features)

### 1. 多维度同步分析

#### 帧数对比
- 绝对差异和百分比差异
- 与配置阈值对比
- 评级：优秀/良好/一般

#### 时间对比
- 录制时长差异
- 百分比差异
- 评级：优秀/良好/一般

#### 启动同步
- 两个相机的首帧时间戳对比
- 启动延迟（毫秒级）
- 判断哪个相机晚启动
- 评级：<10ms优秀，<50ms良好

#### 时间戳对齐分析（核心）
- 采样多个时间点分析时间偏差
- 平均偏差、最大偏差、标准差
- 偏差分布统计：
  - <10ms: 优秀
  - 10-30ms: 良好
  - 30-50ms: 一般
  - >50ms: 较差
- 详细采样点对比表格

#### 帧率稳定性
- 平均帧间隔
- 帧间隔标准差
- 帧间隔范围（最小~最大）
- 稳定性评级

### 2. 综合评估与建议

系统会根据所有分析结果给出：
- 综合评级
- 具体建议（如是否需要使用时间戳匹配）

## 性能优化 (Performance)

### 多线程并行处理
- 使用`ThreadPoolExecutor`并行读取所有timestamp文件
- 10个工作线程同时处理
- 大幅提升I/O密集型操作速度

### 实测性能
- 分析73,000+帧的时间戳
- 读取10个JSONL文件
- **总耗时**: <1秒
- **加速比**: 约5-10倍（相比串行处理）

## 报告示例 (Report Example)

```
================================================================================
2. 同步质量分析 (Synchronization Quality Analysis)
================================================================================

2.1 帧数对比:
  - 绝对差异: 3 帧
  - 百分比差异: 0.00%
  - 验证阈值: 5.00%
  - 评级: ✅ 优秀 (Excellent)

2.2 时间对比:
  - 录制时长差异: 0.001秒
  - 百分比差异: 0.000%
  - 评级: ✅ 优秀 (Excellent)

2.3 启动同步:
  - Cam0首帧时间: 2024-01-07 10:30:18.836
  - Cam1首帧时间: 2024-01-07 10:30:18.835
  - 启动延迟: 0.868ms (Cam0晚启动)
  - 评级: ✅ 优秀 (Excellent)

2.4 时间戳对齐分析:
  - 采样点数: 20
  - 平均时间偏差: 44.27ms
  - 最大时间偏差: 101.38ms
  - 标准差: 25.34ms
  
  偏差分布:
    <10ms:     4帧 ( 20.0%) ⚠️
    10-30ms:   8帧 ( 40.0%) ⚠️
    30-50ms:   5帧 ( 25.0%) ⚠️
    >50ms:     3帧 ( 15.0%) ❌
  
  采样点详细对比:
    帧索引    Cam0时间    Cam1时间      时间差  状态
    ------------------------------------------------------------
           0       0.000s       0.000s     +0.87ms  ✅
        3654     121.800s     121.850s    -50.00ms  ❌
        7309     243.633s     243.700s    -67.00ms  ❌
       10963     365.433s     365.480s    -47.00ms  ⚠️
       14618     487.267s     487.320s    -53.00ms  ❌
       18272     609.067s     609.100s    -33.00ms  ⚠️
       21927     730.900s     730.950s    -50.00ms  ❌
       25581     852.700s     852.730s    -30.00ms  ⚠️
       29236     974.533s     974.580s    -47.00ms  ⚠️
       32890    1096.333s    1096.360s    -27.00ms  ⚠️
    ... (显示前10个采样点，共20个)
  
  评级: ⚠️ 一般

2.5 帧率稳定性:
  Cam0:
    - 平均帧间隔: 33.33ms
    - 标准差: 2.50ms
    - 范围: 28.50ms ~ 45.20ms
    - 稳定性: ✅ 良好
  
  Cam1:
    - 平均帧间隔: 33.32ms
    - 标准差: 3.10ms
    - 范围: 27.80ms ~ 50.30ms
    - 稳定性: ✅ 良好

2.6 综合评估与建议:
  - 帧数同步: ✅ 优秀
  - 时间同步: ⚠️ 一般
  - 帧率稳定: ✅ 良好
  
  建议:
    • 平均时间偏差较大(30-50ms)，强烈建议使用时间戳匹配
    • 检测到最大偏差101.4ms，可能存在帧丢失或时间戳跳变
    • 仅20.0%的帧偏差<10ms，同步质量需要改善
```

## 配置选项 (Configuration)

在`config.yaml`中添加：

```yaml
# Enable timestamp analysis
timestamp_analysis_enabled: true

# Time sync threshold in milliseconds
timestamp_sync_threshold_ms: 50.0

# Number of sample points for drift analysis
timestamp_sample_points: 20
```

### 配置说明

- `timestamp_analysis_enabled`: 是否启用时间戳分析（默认：true）
- `timestamp_sync_threshold_ms`: 时间同步阈值，超过此值会给出警告（默认：50ms）
- `timestamp_sample_points`: 采样点数量，用于详细分析（默认：20）

## 技术实现 (Technical Implementation)

### 核心模块

**文件**: `src/timestamp_analysis.py`

主要类：
- `TimestampStats`: 单个相机的时间戳统计
- `SyncAnalysis`: 两个相机的同步分析结果
- `TimestampAnalyzer`: 分析器主类

### 关键方法

```python
# 并行加载所有timestamp文件
def analyze_all_segments(input_dir, cam0_segments, cam1_segments):
    with ThreadPoolExecutor(max_workers=10) as executor:
        # 并行提交所有加载任务
        futures = [executor.submit(load_segment_timestamps, seg) 
                   for seg in all_segments]
        # 收集结果
        results = [future.result() for future in as_completed(futures)]
```

### 数据流

```
JSONL文件 → 并行读取 → 合并时间戳 → 计算统计 → 分析偏差 → 生成评级 → 输出报告
   (10个)    (多线程)    (排序)      (并行)     (采样)     (规则)     (文本)
```

## 使用场景 (Use Cases)

### 场景1: 科学实验
- 需要精确时间同步（<10ms）
- 必须使用时间戳匹配
- 关注最大偏差

### 场景2: 普通视频
- 可接受一定偏差（<50ms）
- 按帧号匹配即可
- 关注平均偏差

### 场景3: 质量检查
- 检测相机启动延迟
- 发现帧丢失或跳变
- 评估帧率稳定性

## 下一步优化 (Future Enhancements)

### 可选功能
1. **基于时间戳的帧匹配**
   - 不按帧号，按时间戳匹配
   - 自动处理帧率差异
   - 提供更精确的同步

2. **可视化图表**
   - 时间偏差曲线图
   - 帧率波动图
   - HTML报告

3. **自动修正**
   - 检测到偏差过大时自动切换到时间戳匹配
   - 智能采样间隔调整

## 版本信息 (Version)

- **版本**: v1.2.0 (Timestamp Analysis)
- **更新日期**: 2026-01-30
- **新增需求**: Requirement 12 - Timestamp Synchronization Analysis
- **性能**: 多线程并行处理，<1秒完成分析
